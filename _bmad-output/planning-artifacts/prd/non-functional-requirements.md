# Non-Functional Requirements

## Performance

- NFR1: 96时段AI报价建议生成延迟 < 30秒（从触发到全部时段结果呈现，含完整多Agent协作链路：预测Agent→策略Agent→储能Agent→风控Agent→协调Agent汇总）（测量方式：在10并发用户负载下，使用Langfuse记录每次完整Agent链路的端到端耗时，每次报价触发均自动采集，以P95延迟为达标基准，测试环境与生产环境规格一致。）

- NFR2: 功率预测曲线加载时间 < 5秒（测量方式：使用k6在10并发用户场景下，对功率预测曲线页面接口发起请求，记录从请求发出到前端数据完整渲染的P95响应时间，每次版本发布前执行一次回归测试。）

- NFR3: 历史回测（1年数据量）执行时间 < 10分钟（测量方式：在标准生产规格数据库中预置1年完整历史数据（约365天×96时段），通过自动化测试脚本触发回测任务并记录从任务提交到结果完成写入的总耗时，每次核心回测逻辑变更后执行验证。）

- NFR4: 收益看板页面加载时间 < 3秒（测量方式：使用k6在10并发用户负载下对收益看板主页接口进行测试，记录从HTTP请求发起到前端页面关键内容可交互（TTI）的P95耗时，每次发布前执行。）

- NFR5: 系统支持同一实例内至少10个并发用户操作（对应一个交易团队规模）（测量方式：使用Locust模拟10个并发用户同时执行典型操作序列（报价查看、数据导入、看板刷新），持续运行10分钟，验证期间无5xx错误且所有接口P95响应时间满足对应NFR阈值，每次发布前执行。）

- NFR20: 储能96时段充放电计划生成延迟 < 30秒（含设备约束校验）（测量方式：在10并发用户负载下，使用Langfuse记录从储能调度引擎接收到计划生成请求到输出完整96时段计划（含约束校验完成）的端到端耗时，以P95延迟为达标基准，每次发布前自动回归。）

- NFR21: 储能调度指令从交易员确认到运维员端展示延迟 < 10秒（测量方式：在集成测试环境中，记录交易员确认操作的服务端时间戳与运维员端收到WebSocket推送并完成页面渲染的时间戳之差，使用自动化脚本模拟10次操作取P95值，每次消息链路变更后执行验证。）

## Security

- NFR6: 所有数据传输使用TLS 1.2+加密（测量方式：在测试环境中使用testssl.sh对所有对外暴露的HTTPS/WSS端点逐一扫描，验证协议版本不低于TLS 1.2且不存在弱密码套件，每季度执行一次全量扫描并留存报告。）

- NFR7: 所有敏感数据（交易数据、AI模型参数）采用AES-256加密存储，数据库字段级加密（测量方式：通过代码审查确认加密实现使用AES-256算法，同时使用pg_stat_activity及数据库字段Schema元数据检查确认已标记加密字段均配置字段级加密，每次数据库Schema变更后触发合规检查。）

- NFR8: 用户认证支持强密码策略（最少8位，须含大小写字母+数字+特殊字符），会话超时30分钟无操作自动登出，连续5次登录失败锁定账户15分钟（测量方式：通过自动化安全测试脚本分别验证弱密码被拒绝、30分钟无操作后会话失效、第5次登录失败后账户锁定生效，每次认证模块变更后全量回归。）

- NFR9: 数据存储和处理完全在中国境内完成，无任何境外数据传输（测量方式：通过基础设施配置审查（云服务商控制台Region设置）和网络出站流量日志审计，确认所有数据库、对象存储、LLM API调用端点均位于中国境内节点，每季度审计一次并留存截图记录。）

- NFR10: 审计日志采用追加写入模式，不可修改或删除（测量方式：使用structlog审计日志模块，通过自动化测试尝试对已写入日志记录执行UPDATE/DELETE操作并验证均返回权限拒绝错误，同时检查日志存储介质（对象存储/数据库）的写保护策略配置，每次发布前执行合规验证。）

## Scalability

- NFR11: 单实例支持管理至少20个电站的完整数据和交易流程（测量方式：在测试实例中预置20个电站的完整基础数据和历史交易数据，使用Locust模拟10并发用户对20个电站并行执行数据查询和报价操作，验证P95响应时间满足对应NFR阈值且无数据隔离错误，在阶段上线前执行。）

- NFR12: 系统架构支持通过新增独立实例方式横向扩展，Phase 1至少支持3个客户实例并行运行，Phase 2扩展至10个（测量方式：在Phase 1验收时，实际部署3个独立客户实例并同步施加10并发用户负载，验证各实例间无资源争抢且关键接口P95响应时间均达标；Phase 2验收时重复上述测试并扩展至10实例，留存各实例性能报告。）

- NFR13: 数据存储设计支持至少3年历史数据的累积，3年数据量下查询响应时间劣化不超过初始数据量的50%（如初始<3秒则3年后<4.5秒）（测量方式：使用pg_stat_statements在初始数据量和模拟3年数据量（通过数据填充脚本）两种条件下，对典型查询SQL进行基准测试，对比P95响应时间劣化比例，在数据库Schema或索引策略变更后执行对比验证。）

- NFR22: 储能调度引擎支持单实例内至少10台储能设备的独立调度计划管理（测量方式：在测试环境中配置10台储能设备并发起并发调度计划生成请求，使用Langfuse记录所有设备的计划生成耗时，验证P95延迟满足NFR20阈值且10台设备计划相互独立无干扰，在调度引擎重构或扩容前执行。）

## Reliability

- NFR14: 交易日（周一至周五）系统可用性 ≥ 99.5%（测量方式：通过Uptime监控工具（如Uptime Kuma，部署于独立监控实例）对核心服务端点每分钟健康检查，按月统计交易日（周一至周五09:00-20:00）内的可用时间比例，监控数据保留至少90天以供SLA审计。）

- NFR15: 数据导入失败时支持断点续传或重新导入，不丢失已处理数据；**断点续传成功率 ≥ 99%（在导入中途模拟失败后重新触发，已处理记录完整率100%，续传后最终完成率 ≥ 99%）**（测量方式：通过自动化测试在导入百万条记录过程中随机注入故障（网络中断/进程重启），验证重新导入后已处理记录无丢失且续传成功完成，每次导入模块变更后执行，连续3次测试均满足阈值为达标。）

- NFR16: AI引擎异常时系统在60秒内自动检测并切换至降级模式（核心功能数据查看、手动操作仍可用），同时触发告警通知系统管理员（测量方式：在测试环境中主动中止AI引擎服务，使用自动化脚本记录从服务中断到降级模式激活的时间戳差值，并验证告警通知已发送至管理员（邮件/钉钉回执），每次AI引擎或熔断策略变更后执行验证。）

- NFR23: 储能调度引擎异常时，系统自动回退到无储能模式生成报价建议，并通知交易员和运维员；**自动回退成功率 ≥ 99%，通知到达延迟 ≤ 60秒**（测量方式：在测试环境中主动中止储能调度引擎服务，使用自动化脚本验证报价建议在无储能模式下正常生成，并检查交易员和运维员端通知（页面弹窗/消息推送）的到达时间戳，每次调度引擎或通知模块变更后执行。）

- NFR24: 储能充放电计划中的每条指令均经过设备约束硬校验，约束违反率为0%（不允许超限指令到达运维员端）（测量方式：在测试环境中构造包含已知越限参数的调度指令输入，执行约束校验流程并验证100%的违规指令被拦截在运维员端之前，通过自动化单元测试和集成测试覆盖边界条件，每次约束校验逻辑变更后执行全量回归。）

- NFR26: 系统故障恢复目标：RTO（恢复时间目标）≤ 4小时，RPO（恢复点目标）≤ 1小时（交易日数据每小时自动备份）（测量方式：每季度执行一次灾难恢复演练，记录从模拟故障触发到系统完全恢复服务的实际耗时（RTO验证），并验证最近一次备份与故障时刻的数据差距不超过1小时（RPO验证），演练结果存档并纳入运维报告。）

- NFR27: 公开市场数据（日前出清价格）获取频率至少每日1次且在每日报价前完成更新，数据陈旧超过24小时时系统在报价页面显著提示（测量方式：通过structlog记录每次市场数据拉取的时间戳，并在报价页面自动化测试中验证数据时间戳超过24小时时提示组件正确渲染，每个交易日通过监控看板自动核查更新记录。）

## Integration

- NFR17: 功率预测模型API接口标准化，新模型接入不需修改核心代码；**新模型接入工作量 ≤ 1人天（仅需配置适配器，不涉及核心代码PR）**（测量方式：以实际接入一个新预测模型为验收测试，记录从适配器编写到集成测试通过的全程工作量（人时），验证全程无需修改核心业务代码（通过代码diff确认），在接口规范首次实现后及每次接口版本升级后执行。）

- NFR18: 外部数据源（交易中心、气象）接口异常时，系统在30秒内自动切换至缓存数据（缓存有效期≤24小时），缓存过期后提示用户手动导入，切换过程中不中断用户操作（测量方式：在测试环境中模拟外部数据源接口超时，使用自动化脚本记录从接口异常检测到缓存数据切换完成的耗时，并验证切换期间前端无中断提示，每次数据源接入或缓存策略变更后执行回归。）

- NFR19: 数据导入接口支持Excel(.xlsx)和CSV格式，单次导入量支持至少100万条记录（测量方式：使用自动化测试脚本分别构造100万条记录的.xlsx和CSV文件发起导入请求，记录导入完成时间和成功记录数，验证无数据丢失且导入在合理时间内完成（参考NFR3阈值），在导入模块变更后执行验证。）

- NFR25: 储能EMS数据导入接口标准化（定义标准数据模板），MVP至少支持3家主流储能EMS厂商（阳光电源/华为/宁德时代）的数据格式转换（测量方式：针对阳光电源、华为、宁德时代各提供一份真实格式样本数据（含边界值），通过自动化集成测试验证3家厂商数据均能正确转换为标准模板并通过字段完整性校验，MVP上线前执行全量验收测试。）

## Multi-Agent

- NFR28: 多Agent协作成功率（完整Agent链路从预测到风控审计执行完成）≥ 95%，以Agent可观测性平台追踪数据衡量（测量方式：通过Langfuse按每日统计完整Agent链路（预测Agent→策略Agent→储能Agent→风控Agent→协调Agent均返回有效结果）的执行次数与总触发次数之比，以滚动7日平均成功率为监控指标，自动每日生成报告。）

- NFR29: 单次多Agent协作的总LLM Token消耗上限为20,000 tokens，超限时自动截断上下文并记录告警日志（测量方式：通过Langfuse记录每次多Agent协作链路的累计Token消耗，验证超过20,000 tokens时系统自动截断且structlog中存在对应告警日志条目，每次Agent提示词或上下文管理策略变更后执行专项测试。）

- NFR30: Agent可观测性平台（自托管部署）记录100%的Agent调用链路（输入/输出/耗时/Token消耗/模型标识），追踪数据保留≥90天（测量方式：通过Langfuse的追踪数据完整性检查——对比应用日志中的Agent调用次数与Langfuse中的Trace记录数，验证缺失率为0%；同时检查最早记录时间戳确认数据保留已超过90天，每月执行一次完整性核查。）

- NFR31: 多Agent系统支持LLM模型热切换——更换LLM模型（本地开源模型/商业API等）仅需修改配置文件，不需修改Agent代码或重新部署；**模型切换操作耗时 ≤ 10分钟（含配置修改、服务重载、冒烟测试通过）**（测量方式：实际执行从一个LLM模型切换至另一模型的全程操作，记录配置修改完成到系统成功调用新模型的耗时，通过代码diff确认无Agent业务代码改动，在接入新模型或切换机制重构后执行验证。）

- NFR32: Agent输入输出须经安全过滤，防止Prompt注入攻击——用户输入和外部数据在传入Agent前进行内容安全检查，Agent输出在呈现前进行格式和内容校验，安全过滤规则可配置更新；**Prompt注入攻击拦截率 ≥ 99%（基于标准Prompt注入测试用例集，至少覆盖20种典型注入模式）**（测量方式：使用标准化Prompt注入测试用例集（覆盖越权指令、角色扮演绕过、数据泄露诱导等典型模式≥20种）对输入过滤模块进行自动化测试，统计拦截成功率，每次安全过滤规则更新后全量回归，结果存档于安全测试报告。）

- NFR33: Agent输出质量须建立基线监控机制——对每个Agent的输出质量（格式合规率、业务逻辑一致性）进行周期性评估（≥每月1次），输出质量偏离基线≥20%时触发告警，防止长期运行中的概念漂移；**基线建立方式：系统上线后首月采集每个Agent≥100条输出样本，计算格式合规率和业务逻辑一致性评分作为基线，此后每月评估值与基线对比**（测量方式：通过Langfuse每月抽取各Agent最新输出样本（≥100条），使用自动化评估脚本计算格式合规率（结构化字段完整性）和业务逻辑一致性评分，与基线对比偏差超过20%时由structlog写入告警日志并推送通知，评估报告每月归档。）
