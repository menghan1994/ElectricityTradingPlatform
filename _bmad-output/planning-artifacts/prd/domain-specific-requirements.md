# Domain-Specific Requirements

## 合规与监管

**电力市场政策合规：**
- 适配136号文（新能源全面入市）和394号文（现货市场全覆盖）的要求
- MVP适配1个省份的完整市场规则（限价范围、结算方式、偏差考核公式、新能源入市模式）
- 架构层面须支持多省差异化规则扩展——各省市场规则差异极大，不可硬编码

**储能调度合规：**
- 储能充放电调度计划须符合电网调度规程要求，不得超出并网协议约定的功率范围
- 储能设备运行须遵守设备厂商约束（SOC上下限、充放电倍率、循环寿命保护），系统生成的调度指令不得违反设备安全边界
- 储能调度记录（充放电指令、执行结果、SOC变化）须完整留痕，满足电网调度审计要求

**数据安全与合规：**
- 遵守《数据安全法》《个人信息保护法》，能源交易数据按三级管控（一般/重要/核心）
- 国资企业数据不得出境，数据存储和处理完全在境内完成
- 交易数据属于重要级别以上，加密存储和传输
- 合规实现细节见 [SaaS B2B Specific Requirements > 合规要求]

**环境合规与绿色能源：**
- 平台需支持记录和展示新能源发电的碳减排量（基于发电量和区域电网排放因子），为客户ESG报告提供数据支撑 **→ 规划为Phase 2功能，MVP不实现**
- 预留绿色电力证书（绿证）管理接口：MVP阶段不实现绿证交易功能，但数据模型须考虑未来与全国绿证核发和交易系统的对接（发改能源〔2023〕1044号） **→ 规划为Phase 3功能，MVP仅需数据模型预留字段**
- 关注可再生能源消纳保障机制（配额制）对交易策略的影响：部分省份的消纳权重指标可能影响新能源上网优先级和结算方式
- 储能电池生命周期管理：记录电池循环次数、容量衰减趋势，Phase 2可扩展对接电池回收合规要求（GB/T 34015系列）

**安全协议：**
- 储能设备运行安全参照GB/T 36276《电力储能用锂离子电池》相关要求，系统设备参数配置须包含厂商提供的安全边界参数
- 应急处理程序：当储能设备触发异常告警（SOC骤变、温度异常、通信中断）时，系统自动冻结该设备的待执行调度指令，通知储能运维员和交易主管，并回退至无储能报价策略
- 调度指令传输完整性：调度指令生成后进行哈希校验，运维端接收时验证一致性，防止传输过程中指令被篡改
- 电网故障场景：当收到电网调度中心限电/弃风弃光指令时，系统应支持手动标记受影响时段，AI报价和储能调度计划自动排除该时段（Phase 2自动化对接）

## 技术约束

**部署模式：本地/私有云部署（硬性要求）**
- 中石油体系为国资企业，不接受公有云SaaS部署
- 系统须支持在客户内网或私有云环境部署运行
- 架构设计需兼顾：本地部署的运维便捷性 + 未来向其他客户推广时的可复制性
- 产品升级和模型更新机制需适配离线/半离线环境

**数据接入：交易中心官方接口**
- 历史交易数据（出清价格、结算数据等）通过交易中心官方接口导入
- 需适配各省交易中心接口格式差异
- MVP阶段先支持1省交易中心的接口对接 + Excel/CSV手动导入作为备选
- 公开市场数据（日前/实时出清价格）通过官方渠道获取

**数据接入：储能EMS/BMS数据**
- 储能设备运行数据（SOC、充放电功率、温度、循环次数等）通过储能EMS系统获取
- MVP阶段采用文件导入方式（Excel/CSV）接入储能历史运行数据和当前SOC状态，降低集成复杂度
- Post-MVP阶段升级为储能EMS标准化API实时对接
- 储能设备参数（额定容量、额定功率、充放电倍率限制、SOC运行范围、电池类型）通过系统配置界面录入

**多智能体架构约束：**
- 采用LangGraph v1.0+作为核心多Agent编排框架（MIT开源协议，支持完全私有化部署）
- 层级式Supervisor + 专业子图架构：协调Agent（Root Supervisor）管理预测子图、策略子图、储能子图
- Agent状态持久化使用PostgreSQL检查点（`langgraph-checkpoint-postgres`），支持中断-恢复的长时间运行流程
- LLM模型无关架构：通过LangChain模型抽象层接入LLM，支持本地开源模型（Qwen3 8B via Ollama/vLLM）+ 商业API（GPT-4o等）混合部署，不同Agent可使用不同模型
- Agent可观测性使用Langfuse自托管部署（替代LangSmith），实现Agent调用链路追踪、Token成本归因、性能监控
- 多Agent系统须支持降级机制：Agent协作失败时自动回退到规则引擎生成报价建议

**AI决策审计与追溯（硬性要求）：**
- 每笔AI报价建议须完整记录Agent级别决策链路：每个Agent的输入数据、输出结果、推理过程、耗时、使用的LLM模型
- 协调Agent记录完整的Agent调用顺序、数据流转路径和最终汇总逻辑
- 交易员的每次人工调整须记录：调整内容、调整理由、操作时间、操作人
- 审计日志长期保存（≥3年），不可篡改，支持按时间/电站/交易员/Agent维度检索
- 满足国资企业内部审计和合规检查的追溯需求

## 领域风险与缓解

| 风险 | 严重性 | 缓解措施 |
|------|--------|---------|
| 省份市场规则变更频繁 | 高 | 规则引擎模块化设计，配置化而非硬编码，交易团队可自行更新 |
| AI预测偏差导致交易损失 | 高 | "AI建议+人工确认"模式，不允许AI自动提交交易；回测验证先行 |
| 交易中心接口变更或不稳定 | 中 | 支持手动Excel/CSV导入作为降级方案 |
| 本地部署环境差异大 | 中 | 容器化部署（Docker/K8s），降低环境依赖；提供部署文档和健康检查工具 |
| 国资审计要求变化 | 中 | 审计日志设计预留扩展字段，保存策略可配置 |
| 交易员对AI不信任 | 中 | 可解释性设计、渐进式信任建立（先回测验证→再辅助建议→再日常使用） |
| 储能调度指令超限损害设备 | 高 | 系统内置设备约束硬校验（SOC上下限、充放电倍率），超限指令自动拦截并告警 |
| 储能SOC数据不准确导致调度失误 | 中 | MVP采用文件导入+人工确认SOC，系统在SOC数据超过合理范围时提示校验 |
| 储能设备故障导致调度计划无法执行 | 中 | 储能调度计划标注"建议性"，陈工可拒绝执行并反馈异常，系统自动回退到无储能报价策略 |
| 多Agent协调失败导致报价建议质量差 | 中 | 协调Agent内置不一致检测，自动重新调用相关Agent；极端情况回退到规则引擎 |
| LLM输出不稳定导致非法96时段报价 | 中高 | JSON Schema结构化输出验证 + Guardrails输入输出校验 + 超限自动拦截 |
| LLM Token成本失控 | 中 | Langfuse全链路Token监控 + 单次Agent调用Token上限20,000 + 智能缓存复用 |
| LangGraph学习曲线延迟开发进度 | 中高 | 前2周专注LangGraph培训 + 从2-3个核心Agent原型开始迭代 |
