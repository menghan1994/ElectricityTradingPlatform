# Epic 2: 电站配置与数据管理

**目标：** 老周可以通过引导式向导配置电站和储能设备参数、配置省份市场规则、批量导入历史交易数据和储能数据，系统自动校验数据质量并提供异常处理界面；系统自动获取公开市场数据。

**FRs覆盖：** FR23, FR24, FR25, FR26, FR27, FR28, FR29, FR47, FR48, FR49

**相关NFRs：** NFR15(断点续传), NFR17(模型API标准化), NFR18(数据源降级缓存), NFR19(100万条导入), NFR25(3家储能EMS格式), NFR27(市场数据每日更新)

---

## Story 2.1: 电站与储能设备配置向导

As a 系统管理员（老周）,
I want 通过引导式向导配置电站基本参数和储能设备参数,
So that 系统拥有电站和储能设备的基础数据，无需IT人员介入即可完成配置。

**Acceptance Criteria:**

**Given** 管理员已登录并进入电站配置页面
**When** 管理员点击"新建电站"并按向导步骤填写装机容量、并网点、电站类型
**Then** 电站创建成功，在电站列表中可见，配置变更记录写入审计日志

**Given** 管理员在电站配置向导中
**When** 该电站配有储能设备，管理员继续填写储能参数（储能容量、额定功率、充放电倍率限制、SOC运行上下限、电池类型）
**Then** 储能设备关联到该电站并保存成功，系统提供标准参数模板供参考

**Given** 管理员填写储能参数时
**When** 输入的SOC上下限不在合理范围（如下限>上限或超出0%-100%）
**Then** 系统即时校验提示错误，阻止保存

**Given** 管理员完成电站配置后
**When** 查看电站列表
**Then** 新电站及其储能设备信息完整显示，向导每步有"这是什么"上下文解释

---

## Story 2.2: 省份市场规则配置

As a 系统管理员（老周）,
I want 配置省份市场规则（限价范围、结算方式、偏差考核公式）,
So that 系统能按不同省份的交易规则正确计算收益和偏差考核。

**Acceptance Criteria:**

**Given** 管理员已登录并进入市场规则配置页面
**When** 管理员选择省份并配置限价范围（最高限价、最低限价）、结算方式
**Then** 市场规则保存成功，配置变更记录写入审计日志

**Given** 管理员配置偏差考核公式
**When** 选择该省适用的偏差考核公式模板并填写参数
**Then** 公式保存成功，后续收益计算和回测将使用该公式

**Given** 已有电站绑定到某省份
**When** 管理员修改该省份的市场规则
**Then** 变更立即生效，变更前后值记录写入审计日志

**Given** 省份规则引擎
**When** 系统加载规则配置
**Then** 支持通过JSON配置文件加载参数差异，通过Python插件模块加载计算逻辑差异（@register_province装饰器）

---

## Story 2.3: 历史交易数据批量导入与质量校验

As a 系统管理员（老周）,
I want 批量导入历史交易数据并自动校验数据质量,
So that 系统拥有回测和分析所需的历史数据基础，且数据质量有保障。

**Acceptance Criteria:**

**Given** 管理员已登录并进入数据导入页面
**When** 管理员上传Excel(.xlsx)或CSV格式的历史交易数据文件
**Then** 系统开始导入并显示进度

**Given** 数据导入过程中
**When** 系统对每条记录执行质量校验（时段完整性、价格范围合理性、数据格式、重复检测）
**Then** 异常数据按类型（缺失/格式错误/超范围/重复）标记，导入完成后展示数据完整性百分比和异常明细

**Given** 导入过程中发生中断（网络故障或手动取消）
**When** 管理员重新触发导入
**Then** 系统支持断点续传或重新导入，已处理数据不丢失

**Given** 单次导入数据量为100万条记录
**When** 导入执行完成
**Then** 所有记录正确处理，无数据丢失

**Given** 导入完成后
**When** 导入操作记录
**Then** 导入操作（文件名、记录数、成功/失败数、操作人、时间）写入审计日志

---

## Story 2.4: 异常数据管理与修正

As a 系统管理员（老周）,
I want 按异常类型和导入批次筛选查看异常数据，并进行修正操作,
So that 我能快速处理数据质量问题，确保系统数据准确可用。

**Acceptance Criteria:**

**Given** 存在已标记异常的导入数据
**When** 管理员按异常类型（缺失/格式错误/超范围/重复）筛选
**Then** 异常数据列表按类型分组展示

**Given** 管理员查看异常数据列表
**When** 管理员按导入批次筛选
**Then** 仅显示该批次的异常数据

**Given** 管理员选中一条异常数据
**When** 管理员编辑修正该条数据并保存
**Then** 数据更新成功，异常标记移除，修正操作记录写入审计日志

**Given** 管理员选中多条异常数据
**When** 管理员执行"批量删除"操作
**Then** 选中数据被删除，操作记录写入审计日志

**Given** 管理员判断某条异常数据为正常情况（如节假日停市）
**When** 管理员标记"已确认正常"
**Then** 异常标记移除，数据保留，操作记录写入审计日志

---

## Story 2.5: 电站出力数据与储能运行数据导入

As a 系统管理员（老周）,
I want 导入电站实际出力数据和储能历史运行数据（SOC、充放电功率、循环次数），并更新储能当前SOC状态,
So that 系统拥有收益计算和储能调度所需的运行数据。

**Acceptance Criteria:**

**Given** 管理员已登录并进入数据导入页面
**When** 管理员上传电站实际出力数据文件（Excel/CSV，字段包含时段编号、实际出力kW、电站ID）
**Then** 系统按交易日批量导入并经过FR26定义的数据质量校验流程

**Given** 管理员上传储能历史运行数据文件（Excel/CSV）
**When** 文件包含SOC、充放电功率、循环次数数据
**Then** 数据导入成功，系统对SOC范围合理性和功率数据连续性进行校验，异常数据标记

**Given** 管理员需要更新储能当前SOC状态
**When** 管理员通过文件导入方式更新SOC
**Then** SOC状态更新成功，后续储能调度计划使用最新SOC值

**Given** 储能数据导入接口
**When** 导入阳光电源、华为或宁德时代格式的储能EMS数据
**Then** 系统正确转换为标准模板格式并通过字段完整性校验（MVP至少支持3家厂商格式）

---

## Story 2.6: 公开市场数据自动获取

As a 系统用户,
I want 系统自动通过省级电力交易中心公开API获取日前出清价格数据,
So that 报价决策和回测分析基于最新的市场数据。

**Acceptance Criteria:**

**Given** 系统已配置省级电力交易中心API接入参数
**When** 每日报价截止时间前
**Then** 系统自动完成当日96时段出清价格数据同步（字段含时段编号、出清价格元/MWh）

**Given** API调用失败（网络异常或接口变更）
**When** 数据获取失败
**Then** 系统在30秒内自动切换至缓存数据（缓存有效期≤24小时），发出告警并记录失败日志，不影响基于历史价格的回测功能

**Given** 市场数据最后更新时间超过24小时
**When** 用户访问报价相关页面
**Then** 页面显著提示数据陈旧警告（DataFreshnessBadge），含最后更新时间戳

**Given** 缓存数据已过期（>24小时）且API仍不可用
**When** 用户访问市场数据
**Then** 系统提示用户可通过手动导入Excel/CSV方式补充数据

---
