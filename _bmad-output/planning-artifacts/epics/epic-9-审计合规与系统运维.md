# Epic 9: 审计合规与系统运维

**目标：** 系统自动记录所有AI决策链路和关键操作的审计日志；交易主管可按多维度检索审计日志；审计数据≥3年不可篡改。

**FRs覆盖：** FR34, FR35, FR36, FR37, FR57

**相关NFRs：** NFR10(追加写入不可篡改), NFR13(3年数据), NFR26(RTO/RPO)

---

## Story 9.1: AI决策链路审计记录

As a 系统,
I want 完整记录每笔AI报价建议的Agent级别决策链路,
So that 每个AI决策可追溯，满足国资企业合规审计要求。

**Acceptance Criteria:**

**Given** 多Agent协作完成一次报价建议生成
**When** 协作流程结束
**Then** 系统记录完整执行链路：每个Agent的输入数据、输出结果、推理过程、耗时、使用的LLM模型

**Given** 协调Agent完成汇总
**When** 记录审计数据
**Then** 包含协调Agent的调用顺序和数据流转路径

**Given** 报价建议含储能调度建议
**When** 记录审计数据
**Then** 储能Agent的输入（SOC状态、电价预测）、输出（充放电计划）、约束校验结果完整记录

**Given** 审计日志存储
**When** 写入方式
**Then** 采用追加写入模式，已写入记录不可修改或删除

---

## Story 9.2: 操作审计日志记录

As a 系统,
I want 自动记录所有关键操作的审计日志,
So that 所有业务操作有据可查，满足合规要求。

**Acceptance Criteria:**

**Given** 用户执行以下任一操作
**When** 报价方案确认/修改、储能调度计划确认/修改、储能指令确认/拒绝、用户账户创建/停用、角色分配变更、电站绑定变更、市场规则配置变更、数据导入操作
**Then** 系统自动记录审计日志：时间戳、操作人、操作内容、变更前后值

**Given** 审计日志记录
**When** 写入存储
**Then** 采用追加写入模式（structlog审计日志模块），不可修改或删除，尝试UPDATE/DELETE操作返回权限拒绝错误

---

## Story 9.3: 审计日志检索与查看

As a 交易主管（赵磊）,
I want 按时间/电站/交易员维度检索审计日志,
So that 我能在需要时快速找到特定操作记录进行审查。

**Acceptance Criteria:**

**Given** 交易主管已登录并进入审计日志页面
**When** 按时间范围筛选
**Then** 展示该时间段内的所有审计日志，按时间倒序排列

**Given** 审计日志页面
**When** 按电站筛选
**Then** 仅展示与所选电站相关的审计日志

**Given** 审计日志页面
**When** 按交易员筛选
**Then** 仅展示所选交易员的操作日志

**Given** 审计日志页面
**When** 组合多个筛选条件（时间+电站+交易员）
**Then** 筛选条件取交集，结果精确

**Given** 审计日志详情
**When** 点击某条日志
**Then** 展示完整的操作详情：操作类型、操作人、时间戳、变更前后值对比、关联的trace_id

---

## Story 9.4: 审计日志长期保存与数据备份

As a 系统,
I want 审计日志长期保存≥3年且不可篡改，并建立数据备份恢复机制,
So that 满足国资企业合规审计的长期追溯要求和灾难恢复需求。

**Acceptance Criteria:**

**Given** 审计日志数据
**When** 数据持续累积
**Then** 存储设计支持至少3年历史数据累积，3年数据量下查询响应时间劣化不超过初始的50%

**Given** 审计日志存储
**When** 验证不可篡改性
**Then** 存储介质配置写保护策略，任何UPDATE/DELETE尝试均被拒绝

**Given** 系统数据备份
**When** 交易日运行期间
**Then** 每小时执行pg_dump全量备份 + WAL持续归档，满足RPO≤1小时

**Given** 系统发生故障
**When** 执行灾难恢复
**Then** RTO≤4小时，通过恢复脚本从最近备份 + WAL归档完成PITR时间点恢复

---
