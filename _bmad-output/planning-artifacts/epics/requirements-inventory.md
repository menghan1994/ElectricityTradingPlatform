# Requirements Inventory

## Functional Requirements

FR1: 交易员可查看指定电站的96时段功率预测曲线及置信区间
FR2: 交易员可切换查看不同预测模型的预测结果（MVP仅1个自有模型）
FR3: 系统管理员可配置功率预测模型的接入参数（API端点、认证密钥、调用频率、超时时间）并监控运行状态（运行中/异常/已停用），异常时系统自动告警
FR4: 系统通过标准化API接入自有功率预测模型，在每交易日T-1日指定时间前完成当日96时段预测数据拉取（数据字段包含时段编号、预测功率kW、置信区间上下限）；API响应超时或调用失败时系统在5分钟内发出告警并记录失败原因
FR5: 系统通过多Agent协作流程（预测Agent→策略Agent→储能Agent→风控Agent→协调Agent），基于功率预测、电价预测和储能状态（配有储能的电站）自动生成96时段的报量报价建议及储能充放电计划
FR6: 交易员可查看每个时段的AI报价建议及其推荐理由（规则描述级可解释性）
FR7: 交易员可对AI报价建议进行逐时段微调并记录调整理由
FR8: 交易员完成所有时段报价审核后可确认最终报价方案；系统收到确认后将申报状态更新为"已提交"，自动记录确认时间戳和操作人，并触发储能调度指令生成流程（如适用）；若有时段数据缺失则阻止确认并提示具体缺失时段
FR9: 系统识别负电价风险时段并向交易员发出预警；对配有储能的电站，同时生成储能充电建议（含预计SOC变化和后续放电窗口推荐）
FR10: 系统记录交易员对AI建议的每次覆盖操作（含调整内容、理由、时间、操作人）
FR11: 交易主管可选择指定电站和自定义时间范围（支持按日/月/年），使用真实历史数据运行AI策略回测，回测结果至少包含总收益对比、逐日收益曲线和关键偏差时段列表
FR12: 系统计算AI策略（含储能联合优化）与实际执行策略的收益差异
FR13: 系统对收益差异进行归因分析（追溯到具体时段和具体原因），对配有储能的电站单独展示储能贡献（套利收益、偏差平滑节省、负电价避损）
FR14: 交易主管可按自定义时间范围查看负电价专题分析，包含：负电价时段清单、各时段AI策略推荐（零出力/储能充电）、实际执行对比、避损金额汇总、储能充电贡献明细
FR15: 交易主管可生成并导出可视化回测报告（PDF格式）
FR16: 高管可查看管理层回测报告，展示全年或自定义时段的AI策略累计增收总额及百分比、储能贡献占比、负电价避损金额、关键月份趋势图，支持按电站筛选
FR17: 交易主管可按电站维度查看指定时间范围（支持日/周/月/自定义）的交易收益汇总，至少包含：总发电收益（元）、偏差考核费用（元）、净收益（元）、储能套利收益（元，仅限配有储能的电站），支持按电站和时间范围筛选
FR18: 交易主管可查看指定时间范围内AI报价策略收益与交易员实际执行收益的对比看板（"AI策略收益"定义为以AI建议方案为输入、使用真实结算价格的回测模拟结果），至少展示：AI策略总收益、实际执行总收益、差异金额、差异百分比、逐月趋势折线图，支持按电站筛选
FR19: 交易主管可按电站和时间范围查看偏差考核费用跟踪数据，包含：逐日偏差率及方向（正/负偏差）、偏差考核费用金额、超标时段明细、储能偏差平滑贡献量，支持按月环比分析
FR20: 交易主管可按交易员维度查看绩效分析（含AI建议采纳率）
FR21: 高管（角色：高管只读）可查看跨所有电站的整体收益看板，至少包含：本月/本年度累计净收益（元）、AI策略增收贡献金额及百分比、储能贡献占比、各电站净收益排名，默认展示本自然月数据，支持自定义时间范围；所有数据字段为只读展示
FR22: 交易员可查看自己负责电站的日/月交易收益（含偏差考核费用），以及每次人工干预的收益归因明细（调整时段、调整内容、收益影响金额）
FR23: 系统管理员可通过引导式向导配置电站基本参数（装机容量、并网点、电站类型）及储能设备参数（储能容量、额定功率、充放电倍率限制、SOC运行上下限、电池类型，系统提供标准模板）
FR24: 系统管理员可配置省份市场规则（限价范围、结算方式、偏差考核公式）
FR25: 系统管理员可批量导入历史交易数据（Excel/CSV格式）
FR26: 系统对导入数据进行质量校验（时段完整性、价格范围合理性、数据格式、重复检测），将异常数据按类型（缺失/格式错误/超范围/重复）标记，并展示数据完整性百分比和异常明细
FR27: 系统管理员可按异常类型和导入批次筛选查看异常数据列表，支持单条编辑修正、批量删除和标记"已确认正常"操作，修正操作记录审计日志
FR28: 系统通过省级电力交易中心公开API获取日前出清价格数据（每日在报价截止时间前完成当日96时段价格数据同步，数据字段包含时段编号、出清价格元/MWh）；接入失败时发出告警并记录失败日志，不影响基于历史价格的回测功能
FR29: 系统接入电站实际出力数据——MVP阶段以文件导入为主（Excel/CSV格式，字段包含时段编号、实际出力kW、电站ID），支持按交易日批量导入；Post-MVP通过电站SCADA系统API实现准实时对接。文件导入须经过FR26定义的数据质量校验流程
FR30: 系统管理员可创建用户账户（用户名、姓名、联系方式），并管理账户（编辑信息、重置密码、停用/启用账户），操作记录审计日志
FR31: 系统管理员可为用户分配角色（管理员/交易员/储能运维员/交易主管/高管只读）
FR32: 系统管理员可配置交易员与电站的绑定关系（支持一对多）
FR33: 系统按角色和电站绑定关系控制用户的数据访问范围
FR34: 系统完整记录每笔AI报价建议（含储能调度建议）的Agent级别决策链路：每个Agent的输入数据、输出结果、推理过程、耗时、使用的LLM模型，以及协调Agent的调用顺序和数据流转路径
FR35: 系统记录以下操作的审计日志（时间戳+操作人+操作内容+变更前后值）：报价方案确认/修改、储能调度计划确认/修改、储能指令确认/拒绝、用户账户创建/停用、角色分配变更、电站绑定变更、市场规则配置变更、数据导入操作
FR36: 交易主管可按时间/电站/交易员维度检索审计日志
FR37: 系统长期保存审计日志（≥3年），保证不可篡改
FR38: 系统基于功率预测、电价预测和当前SOC状态，自动生成日前96时段储能充放电计划
FR39: 充放电计划生成时自动校验设备约束（SOC上下限、充放电倍率），超限指令自动拦截并告警
FR40: 交易员可查看储能充放电计划及每个时段的策略建议（充电/放电/待机）和推荐理由
FR41: 交易员可对储能充放电计划进行逐时段微调并记录调整理由
FR42: 交易员确认储能调度计划后，系统生成调度指令发送给储能运维员
FR43: 储能运维员可查看待执行的调度指令（时间、功率、方向），确认执行或拒绝并反馈异常原因
FR44: 系统展示储能SOC状态（当前SOC、预计SOC变化曲线）
FR45: 系统实现负电价时段储能充电策略（识别负电价时段→建议储能充电→推荐后续放电窗口）
FR46: 系统基于电价预测和设备约束，自动计算96时段的最优充放电组合方案（输出每时段充/放/待机指令及预计收益），以净收益最大化为目标函数，并展示预计套利收益金额
FR47: 系统管理员可通过文件导入方式（Excel/CSV）导入储能历史运行数据（SOC、充放电功率、循环次数）
FR48: 系统管理员可通过文件导入方式更新储能当前SOC状态（每交易日至少一次）
FR49: 系统对导入的储能数据进行质量校验（SOC范围合理性、功率数据连续性）并标记异常
FR50: 交易员可在电站列表视图中批量查看所负责电站的关键状态（今日申报状态、最新预测偏差、储能SOC），支持按电站名称和状态筛选
FR51: 系统展示每日申报状态跟踪（未开始/AI建议已生成/交易员已审核/已提交），交易员可按状态筛选电站
FR52: 系统管理员可配置储能运维员与储能设备的绑定关系（支持一对多），运维员仅可查看和操作所绑定设备的调度指令
FR53: 交易主管可按是否配备储能对电站收益进行分组对比分析，展示有储能电站组与无储能电站组的收益差异、储能增量贡献汇总（套利收益、偏差平滑节省、负电价避损）
FR54: 系统通过协调Agent统一管理预测Agent、策略Agent、储能Agent、风控Agent的协作执行顺序和数据流转，实现端到端96时段报价建议生成
FR55: 交易员可查看Agent决策链路——每个Agent的输入摘要、输出结果、推理耗时及置信度评分，了解AI报价建议的完整生成过程
FR56: 系统在多Agent协作完成后通过中断-恢复机制暂停等待交易员审核，交易员可批准、修改或拒绝后恢复流程继续执行（如提交申报或重新生成）
FR57: 系统记录每次多Agent协作的完整执行链路（每个Agent的输入/输出/状态/耗时/使用的LLM模型），作为审计日志的组成部分
FR58: 系统在Agent协作失败（Agent异常/超时60秒/输出校验失败，单次链路累计失败超过2次）时自动降级为规则引擎生成报价建议（基于电站历史报价均值和当日功率预测生成96时段基础报价），并在界面以醒目提示交易员当前处于降级模式及降级原因；降级事件自动记录至审计日志；Agent系统恢复后自动提示交易员可切换回AI建议
FR59: 系统将多Agent协作流程的状态持久化存储，支持流程在任意Agent节点中断后从最近检查点恢复执行，无需重新运行已完成的Agent；持久化数据包含每个Agent的执行状态、输入输出快照和检查点时间戳；系统异常重启后自动恢复未完成的协作流程
FR60: 系统提供Agent可观测性看板，展示多Agent协作的运行指标，至少包含：各Agent调用成功率、平均耗时、Token消耗趋势、协作链路失败率Top原因；系统管理员可配置告警规则（如协作成功率低于阈值、Token消耗超预算），告警通过页面通知推送；追踪数据保留≥90天

## NonFunctional Requirements

NFR1: 96时段AI报价建议生成延迟 < 30秒（含完整多Agent协作链路，P95，10并发）
NFR2: 功率预测曲线加载时间 < 5秒（P95，10并发）
NFR3: 历史回测（1年数据量）执行时间 < 10分钟
NFR4: 收益看板页面加载时间 < 3秒（P95，10并发）
NFR5: 系统支持同一实例内至少10个并发用户操作
NFR6: 所有数据传输使用TLS 1.2+加密
NFR7: 所有敏感数据（交易数据、AI模型参数）采用AES-256加密存储，数据库字段级加密
NFR8: 用户认证支持强密码策略（最少8位，含大小写+数字+特殊字符），会话超时30分钟，连续5次登录失败锁定15分钟
NFR9: 数据存储和处理完全在中国境内完成，无任何境外数据传输
NFR10: 审计日志采用追加写入模式，不可修改或删除
NFR11: 单实例支持管理至少20个电站
NFR12: 系统架构支持通过新增独立实例横向扩展，Phase 1至少3个客户实例
NFR13: 数据存储设计支持至少3年历史数据累积，查询劣化不超过50%
NFR14: 交易日系统可用性 ≥ 99.5%
NFR15: 数据导入失败时支持断点续传或重新导入，不丢失已处理数据
NFR16: AI引擎异常时系统在60秒内自动检测并切换至降级模式
NFR17: 功率预测模型API接口标准化，新模型接入≤1人天
NFR18: 外部数据源接口异常时，30秒内自动切换至缓存数据
NFR19: 数据导入接口支持Excel(.xlsx)和CSV，单次≥100万条记录
NFR20: 储能96时段充放电计划生成延迟 < 30秒（P95，10并发）
NFR21: 储能调度指令从交易员确认到运维员端展示延迟 < 10秒
NFR22: 储能调度引擎支持单实例内至少10台储能设备独立调度
NFR23: 储能调度引擎异常时自动回退到无储能模式，通知延迟≤60秒
NFR24: 储能充放电指令设备约束硬校验，违反率为0%
NFR25: 储能EMS数据导入接口标准化，MVP至少支持3家主流厂商格式
NFR26: RTO≤4小时，RPO≤1小时（交易日每小时自动备份）
NFR27: 公开市场数据每日至少更新1次且在报价前完成，数据陈旧超24小时显著提示
NFR28: 多Agent协作成功率≥95%
NFR29: 单次多Agent协作总LLM Token消耗上限20,000 tokens
NFR30: Agent可观测性平台记录100%调用链路，追踪数据保留≥90天
NFR31: 多Agent系统支持LLM模型热切换，仅改配置不改代码，≤10分钟
NFR32: Agent输入输出安全过滤，Prompt注入攻击拦截率≥99%
NFR33: Agent输出质量基线监控，偏离≥20%触发告警，每月≥1次评估

## Additional Requirements

**架构文档额外需求：**
- 自定义脚手架搭建：Vue 3 + Vite 7前端、Python FastAPI后端、LangGraph Agent引擎三个独立服务，Docker Compose统一编排
- PostgreSQL多Schema隔离：public（业务数据）、langgraph（Agent检查点）、timeseries（TimescaleDB超表）
- JWT双Token认证：Access Token（30分钟）+ Refresh Token（7天，httpOnly Cookie）
- RBAC + 资源级权限：FastAPI Dependency注入实现角色校验，数据行级过滤
- RESTful API + OpenAPI自动文档：URL路径版本化 `/api/v1/`
- SSE统一推送：Agent进度、储能调度状态、数据新鲜度通知
- Pinia Store按功能模块拆分 + 电站ID索引：切换电站仅改activeStationId
- 回测引擎混合模式：快速回测（审计日志回放）+ 深度回测（重跑Agent流程）
- 省份规则引擎：配置（JSON）+ 插件化（Python模块 + @register_province装饰器）
- PDF报告：Playwright服务端渲染，Celery异步任务
- 统一错误响应格式：{code, message, detail, trace_id}
- 日志：structlog JSON结构化日志 + Langfuse全链路追踪
- 数据备份：pg_dump每小时全量备份 + WAL归档 PITR
- Agent Engine对public Schema只读访问，写入通过HTTP API回传api-server
- 三层降级策略：Agent→规则引擎；储能引擎→无储能模式；外部数据源→缓存数据

**UX文档额外需求：**
- 桌面Web应用，主要适配1920×1080及以上，最低支持1024px
- 浏览器兼容：Chrome/Edge最新2版本 + 360安全/奇安信可信浏览器（信创）
- WCAG 2.1 AA无障碍合规
- 键盘导航：Tab序、焦点管理、Period96Grid方向键导航、快捷键支持
- 屏幕阅读器ARIA标注
- Agent协作进度实时展示（步骤条 + SSE推送）
- 30秒等待期有意义设计（Agent实时进度流）
- 渐进式Agent决策链路展开（Progressive Disclosure）
- 回测报告数据叙事设计（KPI大数字 + 瀑布图 + 数字动画）
- 多电站标签页切换 + 各站状态独立保持
- 储能-报价交叉引用（一键跳转关联页面）
- 数据新鲜度指示器（DataFreshnessBadge）
- 降级模式信息横幅（非阻断弹窗）

**领域合规额外需求：**
- 适配136号文和394号文电力市场政策
- 储能调度符合电网调度规程，不超出并网协议功率范围
- 调度指令传输哈希校验（完整性防篡改）
- 储能设备异常告警时自动冻结待执行指令
- 数据安全法三级管控（一般/重要/核心）
- 碳减排量记录预留（Phase 2）、绿证接口预留（Phase 3数据模型预留字段）

## FR Coverage Map

| FR | Epic | 简要描述 |
|----|------|---------|
| FR1 | Epic 3 | 96时段功率预测曲线查看 |
| FR2 | Epic 3 | 切换预测模型查看 |
| FR3 | Epic 3 | 预测模型接入参数配置与监控 |
| FR4 | Epic 3 | 标准化API拉取预测数据 |
| FR5 | Epic 4 | 多Agent协作生成报价建议 |
| FR6 | Epic 4 | AI报价建议及推荐理由展示 |
| FR7 | Epic 5 | 逐时段微调AI报价 |
| FR8 | Epic 5 | 确认最终报价方案 |
| FR9 | Epic 4 | 负电价风险识别与储能充电建议 |
| FR10 | Epic 5 | 记录覆盖操作 |
| FR11 | Epic 7 | 历史回测运行 |
| FR12 | Epic 7 | AI vs 实际收益差异计算 |
| FR13 | Epic 7 | 收益差异归因分析 |
| FR14 | Epic 7 | 负电价专题分析 |
| FR15 | Epic 7 | PDF回测报告导出 |
| FR16 | Epic 7 | 管理层回测报告 |
| FR17 | Epic 8 | 交易收益汇总看板 |
| FR18 | Epic 8 | AI vs 实际收益对比看板 |
| FR19 | Epic 8 | 偏差考核费用跟踪 |
| FR20 | Epic 8 | 交易员绩效分析 |
| FR21 | Epic 8 | 高管整体收益看板 |
| FR22 | Epic 8 | 交易员收益与干预归因 |
| FR23 | Epic 2 | 电站和储能设备配置向导 |
| FR24 | Epic 2 | 省份市场规则配置 |
| FR25 | Epic 2 | 批量导入历史交易数据 |
| FR26 | Epic 2 | 数据质量校验 |
| FR27 | Epic 2 | 异常数据管理 |
| FR28 | Epic 2 | 公开市场数据API获取 |
| FR29 | Epic 2 | 电站实际出力数据导入 |
| FR30 | Epic 1 | 用户账户管理 |
| FR31 | Epic 1 | 角色分配 |
| FR32 | Epic 1 | 交易员-电站绑定 |
| FR33 | Epic 1 | 数据访问范围控制 |
| FR34 | Epic 9 | Agent决策链路审计记录 |
| FR35 | Epic 9 | 操作审计日志 |
| FR36 | Epic 9 | 审计日志检索 |
| FR37 | Epic 9 | 审计日志长期保存（≥3年） |
| FR38 | Epic 6 | 储能充放电计划自动生成 |
| FR39 | Epic 6 | 设备约束校验 |
| FR40 | Epic 6 | 储能计划查看与策略建议 |
| FR41 | Epic 6 | 储能计划逐时段微调 |
| FR42 | Epic 6 | 调度指令生成与发送 |
| FR43 | Epic 6 | 运维员指令确认/拒绝 |
| FR44 | Epic 6 | SOC状态展示 |
| FR45 | Epic 6 | 负电价储能充电策略 |
| FR46 | Epic 6 | 最优充放电组合计算 |
| FR47 | Epic 2 | 储能历史运行数据导入 |
| FR48 | Epic 2 | 储能SOC状态更新 |
| FR49 | Epic 2 | 储能数据质量校验 |
| FR50 | Epic 5 | 多电站状态批量查看 |
| FR51 | Epic 5 | 每日申报状态跟踪 |
| FR52 | Epic 1 | 储能运维员-设备绑定 |
| FR53 | Epic 8 | 储能分组对比分析 |
| FR54 | Epic 4 | 协调Agent管理协作流程 |
| FR55 | Epic 4 | Agent决策链路查看 |
| FR56 | Epic 4 | Human-in-the-Loop中断-恢复 |
| FR57 | Epic 9 | Agent执行链路记录（审计） |
| FR58 | Epic 4 | Agent协作失败降级机制 |
| FR59 | Epic 4 | Agent状态持久化与恢复 |
| FR60 | Epic 4 | Agent可观测性看板 |
