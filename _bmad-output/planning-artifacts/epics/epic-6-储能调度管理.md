# Epic 6: 储能调度管理

**目标：** 交易员可查看96时段储能充放电计划及策略建议、微调并确认调度计划；运维员可接收调度指令、确认执行或拒绝并反馈异常；系统展示SOC状态和变化曲线；设备约束硬校验（违反率0%）。

**FRs覆盖：** FR38, FR39, FR40, FR41, FR42, FR43, FR44, FR45, FR46

**相关NFRs：** NFR20(<30秒计划生成), NFR21(<10秒指令推送), NFR22(≥10台设备), NFR23(异常回退), NFR24(约束违反率0%)

---

## Story 6.1: 储能充放电计划自动生成与约束校验

As a 系统,
I want 基于功率预测、电价预测和当前SOC状态自动生成96时段储能充放电计划，并自动校验设备约束,
So that 交易员获得安全可靠的储能调度建议。

**Acceptance Criteria:**

**Given** 电站配有储能设备且功率预测和电价预测数据已就绪
**When** 系统触发储能调度计划生成
**Then** 基于电价预测和设备约束，自动计算96时段的最优充放电组合方案（每时段充/放/待机指令及预计收益），以净收益最大化为目标函数

**Given** 充放电计划生成过程中
**When** 计划中的某时段指令超出设备约束（SOC超出上下限、充放电倍率超限）
**Then** 超限指令自动拦截并告警，调整为安全范围内的最优值，设备约束违反率为0%

**Given** 电价预测存在负电价时段
**When** 系统生成充放电计划
**Then** 自动识别负电价时段并建议储能充电，推荐后续放电窗口

**Given** 储能计划生成
**When** 从触发到输出完整96时段计划
**Then** 延迟<30秒（P95，10并发），含设备约束校验

**Given** 储能调度引擎发生异常
**When** 系统检测到引擎不可用
**Then** 自动回退到无储能模式生成报价建议，并在60秒内通知交易员和运维员

---

## Story 6.2: 储能调度计划查看与微调

As a 交易员（李娜）,
I want 查看96时段储能充放电计划及每个时段的策略建议和推荐理由，并可逐时段微调,
So that 我能审核和优化储能调度方案。

**Acceptance Criteria:**

**Given** 储能充放电计划已生成
**When** 交易员进入储能调度页面
**Then** 展示96时段充放电计划时间轴（甘特图/时间轴），每时段显示策略建议（充电/放电/待机）、功率值和推荐理由，叠加电价曲线

**Given** 交易员查看储能计划
**When** 展示预计套利收益
**Then** 页面显示预计套利收益金额汇总

**Given** 交易员需要调整某时段的充放电策略
**When** 交易员修改时段的充放电功率或策略方向并保存
**Then** 系统弹出调整理由输入框（必填），保存成功后被调整时段标识，调整记录写入审计日志

**Given** 交易员微调后的充放电指令
**When** 调整值超出设备约束（SOC上下限或充放电倍率）
**Then** 系统即时校验拦截并提示约束限制，阻止保存超限值

---

## Story 6.3: SOC状态展示与预测

As a 交易员（李娜）,
I want 查看储能设备的当前SOC状态和预计SOC变化曲线,
So that 我能了解储能设备的实时状态，做出合理的调度决策。

**Acceptance Criteria:**

**Given** 交易员进入储能调度页面
**When** 选择一个配有储能的电站
**Then** 展示储能SOC仪表盘（SOCGauge），显示当前SOC百分比、SOC运行上下限

**Given** 储能充放电计划已生成
**When** 交易员查看SOC曲线
**Then** 展示基于当前计划的96时段预计SOC变化曲线，标注SOC上下限警戒线

**Given** 交易员微调了充放电计划
**When** 微调保存成功
**Then** SOC预测曲线实时联动更新，反映调整后的SOC变化趋势

---

## Story 6.4: 调度指令确认与下发

As a 交易员（李娜）,
I want 确认储能调度计划后系统自动生成调度指令并发送给运维员,
So that 运维员能及时收到明确的执行指令。

**Acceptance Criteria:**

**Given** 交易员已审核完储能调度计划
**When** 交易员点击"确认调度计划"（或Ctrl+Enter快捷键）
**Then** 系统生成调度指令并通过SSE推送发送给对应的储能运维员

**Given** 调度指令生成
**When** 指令内容
**Then** 每条指令包含：执行时间、充放电功率（kW）、方向（充电/放电/待机）、预计SOC变化

**Given** 交易员确认调度计划
**When** 运维员端接收指令
**Then** 从交易员确认到运维员端展示延迟<10秒

**Given** 调度指令生成后
**When** 指令传输过程
**Then** 系统对指令进行哈希校验，运维端接收时验证一致性，防止传输篡改

**Given** 确认操作
**When** 操作完成
**Then** 储能调度计划确认操作写入审计日志

---

## Story 6.5: 运维员调度指令执行与反馈

As a 储能运维员（陈工）,
I want 查看待执行的调度指令并确认执行或拒绝反馈异常,
So that 我能按计划安全执行储能调度操作。

**Acceptance Criteria:**

**Given** 运维员已登录
**When** 进入调度指令页面
**Then** 展示待执行的调度指令列表，每条指令以结构化卡片展示（DispatchCommandCard）：执行时间、充放电功率、方向、预计SOC变化

**Given** 运维员仅绑定了部分储能设备
**When** 查看调度指令
**Then** 仅显示其绑定设备的调度指令

**Given** 运维员查看一条调度指令
**When** 运维员点击"确认执行"
**Then** 指令状态更新为"已确认"，状态通过SSE推送给交易员，操作记录写入审计日志

**Given** 运维员发现设备异常无法执行指令
**When** 运维员点击"拒绝"并填写异常原因
**Then** 指令状态更新为"已拒绝"，异常原因记录并推送给交易员和交易主管，操作记录写入审计日志

**Given** 储能设备触发异常告警（SOC骤变、温度异常、通信中断）
**When** 系统检测到异常
**Then** 自动冻结该设备的待执行调度指令，通知储能运维员和交易主管

---
