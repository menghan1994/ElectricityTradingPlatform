# Epic 7: 历史回测与收益归因分析

**目标：** 交易主管可选择电站和时间范围运行AI策略回测、查看收益差异归因分析（含储能贡献）、查看负电价专题分析、生成PDF报告；高管可查看管理层回测报告。

**FRs覆盖：** FR11, FR12, FR13, FR14, FR15, FR16

**相关NFRs：** NFR3(1年回测<10分钟)

**UX需求：** 回测报告数据叙事设计（KPI大数字+瀑布图+数字动画）、Playwright PDF渲染、Celery异步任务

---

## Story 7.1: 回测任务配置与执行

As a 交易主管（赵磊）,
I want 选择指定电站和自定义时间范围运行AI策略回测,
So that 我能用真实历史数据验证AI策略的实际效果。

**Acceptance Criteria:**

**Given** 交易主管已登录并进入回测分析页面
**When** 主管选择电站、时间范围（支持按日/月/年）并点击"开始回测"
**Then** 系统提交回测任务（Celery异步执行），页面显示回测进度

**Given** 回测任务正在执行
**When** 使用1年完整历史数据（365天×96时段）
**Then** 回测执行时间<10分钟

**Given** 回测任务完成
**When** 结果生成
**Then** 回测结果至少包含：AI策略总收益、实际执行总收益、收益差异金额和百分比、逐日收益曲线、关键偏差时段列表

**Given** 回测使用混合模式
**When** 快速回测
**Then** 复用审计日志中的历史Agent输出进行纯数值计算回放

---

## Story 7.2: 收益差异归因分析

As a 交易主管（赵磊）,
I want 查看AI策略与实际执行的收益差异归因分析,
So that 我能了解收益差异的具体原因，识别改进机会。

**Acceptance Criteria:**

**Given** 回测任务完成
**When** 交易主管查看归因分析
**Then** 系统计算AI策略（含储能联合优化）与实际执行策略的收益差异，归因追溯到具体时段和具体原因

**Given** 电站配有储能
**When** 查看归因分析
**Then** 单独展示储能贡献明细：套利收益、偏差平滑节省、负电价避损金额

**Given** 归因分析结果
**When** 交易主管点击某个偏差时段
**Then** 展示该时段的详细对比：AI建议报量/报价 vs 实际执行报量/报价、收益影响金额

---

## Story 7.3: 负电价专题分析

As a 交易主管（赵磊）,
I want 按自定义时间范围查看负电价专题分析,
So that 我能评估AI在负电价场景下的策略效果和储能贡献价值。

**Acceptance Criteria:**

**Given** 交易主管已登录并进入负电价分析页面
**When** 主管选择时间范围
**Then** 展示负电价时段清单（日期、时段编号、负电价值）

**Given** 负电价时段清单
**When** 查看每个时段详情
**Then** 展示该时段AI策略推荐（零出力/储能充电）与实际执行对比

**Given** 负电价分析汇总
**When** 查看汇总数据
**Then** 展示避损金额汇总、储能充电贡献明细（充电量、后续放电收益、净避损金额）

---

## Story 7.4: 回测报告PDF导出

As a 交易主管（赵磊）,
I want 一键生成并导出可视化回测报告PDF,
So that 我能将报告用于内部汇报和存档。

**Acceptance Criteria:**

**Given** 回测结果已生成
**When** 交易主管点击"导出PDF报告"
**Then** 系统通过Celery异步任务提交PDF生成请求，页面显示模态进度条+"正在生成报告..."

**Given** PDF生成任务执行
**When** Playwright服务端渲染完成
**Then** 自动触发浏览器下载，PDF报告包含KPI卡片、收益归因瀑布图、逐日收益折线图、关键偏差时段表格

**Given** PDF报告内容
**When** 电站配有储能
**Then** 报告包含储能贡献专节（套利收益、偏差平滑节省、负电价避损）

---

## Story 7.5: 管理层回测报告

As a 高管（王总）,
I want 查看管理层回测报告，3秒内看到AI策略的核心增收数据,
So that 我能快速评估AI平台的投资价值并决定是否扩大试用。

**Acceptance Criteria:**

**Given** 高管已登录（高管只读角色）并进入管理层报告页面
**When** 页面加载完成
**Then** 首屏展示大字号KPI卡片：AI策略累计增收总额（数字从0动画过渡到终值，持续1.2秒）、增收百分比、储能贡献占比、负电价避损金额

**Given** 管理层报告
**When** 查看趋势数据
**Then** 展示关键月份趋势图（逐月AI增收金额折线图）

**Given** 管理层报告
**When** 高管按电站筛选
**Then** KPI和趋势图按所选电站过滤更新

**Given** 管理层报告
**When** 高管选择自定义时段（默认全年）
**Then** 所有数据按选定时段重新计算展示

**Given** 管理层报告
**When** 高管尝试任何写操作
**Then** 所有数据字段为只读展示，无编辑入口

---
