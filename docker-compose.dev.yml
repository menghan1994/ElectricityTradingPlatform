services:
  web-frontend:
    build:
      context: ./web-frontend
      dockerfile: Dockerfile
      target: dev
    ports:
      - "5173:5173"
    volumes:
      - ./web-frontend/src:/app/src
      - ./web-frontend/public:/app/public
      - ./web-frontend/index.html:/app/index.html
      - ./web-frontend/vite.config.ts:/app/vite.config.ts
    command: npm run dev -- --host 0.0.0.0
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:5173/', r => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))\""]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s

  api-server:
    build:
      context: ./api-server
      dockerfile: Dockerfile
      target: dev
    volumes:
      - ./api-server/app:/app/app
      - ./api-server/rules:/app/rules
      - ./api-server/tests:/app/tests
      - ./api-server/alembic:/app/alembic
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    env_file:
      - .env.development

  celery-worker:
    volumes:
      - ./api-server/app:/app/app
      - ./api-server/rules:/app/rules
    command: celery -A app.tasks.celery_app worker --loglevel=debug
    env_file:
      - .env.development

  langgraph-app:
    build:
      context: ./agent-engine
      dockerfile: Dockerfile
      target: dev
    volumes:
      - ./agent-engine/app:/app/app
      - ./agent-engine/tests:/app/tests
    command: uvicorn app.main:app --host 0.0.0.0 --port 8100 --reload
    env_file:
      - .env.development
